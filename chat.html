<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link rel="stylesheet" href="./js/chat.style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <script src="https://apis.google.com/js/api:client.js"></script>
  <title>Document</title>
</head>

<body>


  <style>
    .popover-content {
      display: none;
      /* rest of your styles for popover content */
    }

    .popover-content.show {
      display: block;
    }



    .card-body .post-image {
      display: block;
      margin-left: auto;
      margin-right: auto;
      max-width: 80%;
      height: auto;
    }




    h1.text-center.teah {
      font-size: 41px;
      font-weight: 700;
      display: flex;
      color: #343a40;
    }

    .spne {
      margin-top: -19px;
      font-size: 29px;
      color: blue;
      font-weight: 700;
      margin-left: 78px;

    }

    .post-section {

      padding: 10px;

    }

    #post-form {
      margin-bottom: 10px;
    }

    #post-content {
      width: 100%;

      text-align: center;
      border: 1px solid blue;
      padding: 5px;
      border-radius: 3px;
    }

    /*  first pages and */


    /* button#post-button {

  width: 40%;
} */


    button.btn.btn-secondary {
      width: 60%;
      margin: 7px;
      padding: 12px;
      text-align: center;
      background-color: #007bff;
      border-radius: 10px;
      font-size: 15px;
    }


    .post-btn {
      align-items: center;
      text-align: center;

    }

    .card-3 {
      width: auto;
      margin: 0 auto;
      background-color: #fff;

    }





    .card-header {
      display: flex;
      align-items: center;

      padding: 10px;
    }

    .user-name {
      color: #212529;
      font-size: 20px;
      font-weight: normal;
    }

    .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
    }

    .user-info {
      margin-left: 10px;
    }

    .timestamp {
      font-size: 12px;
      color: #888;
    }

    .nice-icon {
      margin-left: auto;
      cursor: pointer;
      font-size: 24px;
      color: blue;
    }





    .card-body {

      padding: 10px;

    }

    .card-body .tweet-text {
      font-size: 17px;
      color: #333;
      line-height: 1.5;
      font-weight: 600;
    }


    span.toipc {
      color: blue;
    }


    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-top: 1px solid #212529;
      border-bottom: 1px solid #212529;
      border-top: 1px solid black;
      border-bottom: 1px solid black;
      margin-top: 30px;
    }

    i.fa-regular.fa-heart {
      position: relative;
      font-size: 20px;
      color: #828a90;
      transition: color 0.2s ease-in-out;
      opacity: 0.7;
    }

    i.fa-regular.fa-face-smile {
      position: relative;
      border-right: 1px solid black;
      border-left: 1px solid black;
      padding-left: 50px;
      padding-right: 50px;
      font-size: 20px;
      color: #0e84dd;
      transition: color 0.2s ease-in-out;
      opacity: 0.7;
    }

    i.fa-solid.fa-thumbs-up {
      position: relative;
      opacity: 0.7;
      font-size: 20px;
      color: #0e84dd;
      transition: color 0.2s ease-in-out;/
    }


    i.fa-regular.fa-heart:hover {
      color: blue;
    }

    i.fa-regular.fa-face-smile:hover {
      color: #828a90;
    }

    i.fa-solid.fa-thumbs-up:hover {
      color: blue;
    }

    i.fa-regular.fa-heart:hover,
    i.fa-regular.fa-face-smile:hover,
    i.fa-solid.fa-thumbs-up:hover {
      opacity: 1;
    }

    .img-container {
      display: flex;

      justify-content: center;
      gap: 1px;
      margin-bottom: 20px;
    }

    .img-container img {
      max-width: 46%;
      height: auto;
      border-radius: 5px 4px 5px 4px;
      margin-top: 30px;
    }

    */ .mobilebar-container {
      position: fixed;
      bottom: 0px;
      z-index: 12;
      left: 50%;
      transform: translateX(-50%);
      border: 1px solid blue;
    }

    .mobilebar-tab {

      background-color: #fff;



      display: flex;
      position: fixed;
      flex-shrink: 0;
      bottom: 0px;
    }

    .mobilebar-tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      flex-shrink: 0;
      cursor: pointer;
      transition: 0.3s;
     
    }

    .mobilebar-tab-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    /* width: 100%; */
    /* flex-shrink: 0; */
    /* cursor: pointer; */
    transition: 0.3s;
    /* position: relative; */
    /* z-index: 2; */
}



    .mobilebar-tab__icon {
      display: block;
      color: #051367;
      transition-duration: 0.3s;
      line-height: 1;
    }




    .popover-content {
      display: none;
    }

    .popover-content.show {
      display: block;
    }


    .show-popover {
      display: block;
    }


    .popover-action-btn {
      display: block;
      width: 35%;
      padding: 6px 16px;
      margin: 6px 0;
      color: #373b3e;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
      margin-top: -3px;
      font-weight: 700;
      font-size: 13px;
    }

    i.fa-regular.fa-heart.like-icon {
    display: flex;
    align-items: center;
}

i.fa-regular.fa-face-smile.like-icon {
    display: flex;
    align-items: center;
}

i.fa-solid.fa-thumbs-up.like-icon {
    display: flex;
    align-items: center;
}

span.like-count {
    margin-left: 17px;
    font-size: 17px;
}

  </style>

  <div class="allchat">
    <div class="chat-home">
      <div class="container">
        <div class="row" style="position: fixed;z-index: 999;width: 100%;height: 165px; background-color: #fff;">
          <div class="col-sm-12">
            <h1 class="text-center teah">Tech</h1>
            <div class="spne">
              <span>X</span>
            </div>


            <div class="post-section">
              <div class="post-btn">
                <a href="./creat.html"><button id="post-button" class="btn btn-secondary">Create Post</button></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>



    <div class="card-3" style="padding-top: 170px;padding-bottom: 40px;">
 
      <div id="posts" style="    padding: 0px 10px;"></div>

    </div>



    <div class="mobilebar-container mobile-layout">
      <nav class="mobilebar-tab">
        <div id="applicationBarMobileButton1" class="mobilebar-tab-item active">
          <span class="mobilebar-tab__icon">
            <a href="./chat.html"> <i class="fa-solid fa-house"></i></a>
          </span>
        </div>
        <div class="mobilebar-tab-item">
          <span class="mobilebar-tab__icon">
            <a href="./profile.html"><i class="fa-solid fa-user"></i></a>
          </span>
        </div>
      </nav>
    </div>






    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>







    <script>





      if (!localStorage.getItem('user')) {
                  window.location.href = 'index.html';
              }

      function loadPosts() {
        const postsContainer = document.getElementById('post-container');
        const posts = JSON.parse(localStorage.getItem('posts')) || [];

        posts.reverse();

        posts.forEach(post => {
          const postElement = renderPost(post);
          postsContainer.insertAdjacentHTML('beforeend', postElement);
        });
      }



      document.addEventListener('DOMContentLoaded', loadPosts);


      document.addEventListener('click', function (event) {
        if (event.target.classList.contains('popoverIcon')) {

          const popoverContent = event.target.closest('.card-header').nextElementSibling;
          if (popoverContent) {
            popoverContent.classList.toggle('show');
          } else {
            console.error('Popover content not found for icon: ', event.target);

          }
        }
      });


      function editPost(postId) {

        window.location.href = `edit.html?postId=${postId}`;
      }




    </script>








    <script type="module">

      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
      import {
        getFirestore,
        collection,
        getDocs,
        deleteDoc,
        doc,
        updateDoc,
        getDoc,
        runTransaction,
        onSnapshot
      } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';
      import { getAuth } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js';
    
      const firebaseConfig = {
        apiKey: "AIzaSyDrUOrEvp3T277JmKPOWVAZ90gBIKC9S50",
        authDomain: "fir-b6449.firebaseapp.com",
        projectId: "fir-b6449",
        storageBucket: "fir-b6449.appspot.com",
        messagingSenderId: "511184942927",
        appId: "1:511184942927:web:debcb811d15856fd86b73a",
        measurementId: "G-2TM34PV1YN"
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      
    
   
    
      function cssEscape(str) {
        if (/^\d/.test(str)) {
          str = '_' + str;
        }
        return String(str).replace(/([!#$%&()*+,./:;<=>?@[\]^`{|}~])/g, '\\$1').replace(/:/g, '\\:');
      }
    
      function updateLikeCountUI(postId, newType) {
        const postElement = document.getElementById(postId);
        if (postElement) {
          const likeCountElements = postElement.querySelectorAll('.like-count');
          likeCountElements.forEach(el => {
            const type = el.getAttribute('data-type');
            let likeCount = parseInt(el.textContent);
            if (type === newType) {
              likeCount++;
            }
            el.textContent = likeCount;
          });
        }
      }
    
      async function updateLikeCount(postId, userId, newType, oldType = null) {
        const postRef = doc(db, 'posts', postId);
        const userLikeRef = doc(db, 'posts', postId, 'likes', userId);
    
        await runTransaction(db, async (transaction) => {
          const postDoc = await transaction.get(postRef);
          if (!postDoc.exists()) {
            throw new Error("Document does not exist!");
          }
    
          const postData = postDoc.data();
          const likes = postData.likes || {};
          const updatedLikes = { ...likes };
    
          if (oldType) {
            updatedLikes[oldType] = (likes[oldType] || 0) - 1;
          }
          updatedLikes[newType] = (likes[newType] || 0) + 1;
    
          let totalLikes = postData.totalLikes || 0;
          if (oldType !== newType) {
            totalLikes += (oldType ? 0 : 1) - (likes[oldType] === 1 ? 1 : 0);
          }
    
          transaction.update(postRef, {
            likes: updatedLikes,
            totalLikes: totalLikes,
            latestLikeTimestamp: Date.now()
          });
          transaction.set(userLikeRef, { type: newType });
        });
      }
    
      async function incrementLikeCount(postId, userEmail, newType) {
        const fcmToken = localStorage.getItem('fcmToken');
    
        const postRef = doc(db, 'posts', postId);
        const userLikeRef = doc(db, 'posts', postId, 'likes', userEmail);
        
    
        await runTransaction(db, async (transaction) => {
          const userLikeDoc = await transaction.get(userLikeRef);
          const postDoc = await transaction.get(postRef);
    
          if (!postDoc.exists()) {
            throw new Error("Post does not exist!");
          }
    
          let oldType = null;
          let postData = postDoc.data();
    
          const likes = postData.likes || {};
          let updatedLikes = { ...likes };
    
          if (userLikeDoc.exists()) {
            oldType = userLikeDoc.data().type;
    
            if (oldType === newType) {
              updatedLikes[oldType] = (likes[oldType] || 0) - 1;
    
              let totalLikes = postData.totalLikes || 0;
              totalLikes -= likes[oldType] === 1 ? 1 : 0;
    
              transaction.update(postRef, {
                likes: updatedLikes,
                totalLikes: totalLikes,
                latestLikeTimestamp: Date.now()
              });
              console.log('New post timestamp:', Date.now());
    
              transaction.delete(userLikeRef);
              return;
            }
          }
    
          if (oldType) {
            updatedLikes[oldType] = (likes[oldType] || 0) - 1;
          }
    
          updatedLikes[newType] = (likes[newType] || 0) + 1;
    
          let totalLikes = 0;
    
          Object.values(updatedLikes).forEach(count => {
            totalLikes += count;
          });
    
          transaction.update(postRef, {
            likes: updatedLikes,
            totalLikes: totalLikes,
            latestLikeTimestamp: Date.now()
          });
    
          if (!userLikeDoc.exists() || oldType !== newType) {
            transaction.set(userLikeRef, { type: newType, userEmail: userEmail });
          }
        }).then(() => {
          updateLikeCountUI(postId, newType);
    
        }).catch((error) => {
          console.error("Transaction failed: ", error);
        });
      }


      async function getPostsRealTime() {
        const postsCol = collection(db, 'posts');
        onSnapshot(postsCol, (snapshot) => {
          console.log('Real-time update triggered!');
          const postsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderPosts(postsList);
        });
      }
    
      async function getPosts() {
        const postsCol = collection(db, 'posts');
        try {
          const postsSnapshot = await getDocs(postsCol);
          const postsList = postsSnapshot.docs.map(doc => {
            return { id: doc.id, ...doc.data() };
          });
    
          renderPosts(postsList);
        } catch (error) {
          console.error("Error fetching posts:", error);
        }
      }
    
      window.deletePost = async function (postId) {
        if (!postId) {
          console.error('No Post ID provided for deletion.');
          return;
        }
    
        const postRef = doc(db, 'posts', postId);
    
        try {
          await deleteDoc(postRef);
    
          getPosts();
        } catch (error) {
          console.error("Error deleting post:", error);
        }
      };
    
      function renderPosts(posts) {
        const postsElement = document.getElementById('posts');
        if (!postsElement) {
          console.error('No element with id "posts" found.');
          return;
        }
    
        if (!Array.isArray(posts)) {
          console.error('Invalid posts data. Expected an array.');
          return;
        }
    
        posts.sort((a, b) => {
          const aTimestamp = a.postObject?.timestamp?.seconds || 0;
          const bTimestamp = b.postObject?.timestamp?.seconds || 0;
          return bTimestamp - aTimestamp;
        });
    
        posts.sort((a, b) => b.latestLikeTimestamp - a.latestLikeTimestamp);
    
        postsElement.innerHTML = '';
    
        posts.forEach(post => {
          const card = document.createElement('div');
          card.className = 'card mb-3';
          const postIdPrefix = /^\d/.test(post.id) ? '_' : '';
          const sanitizedPostId = cssEscape(postIdPrefix + post.id);
          card.setAttribute('id', sanitizedPostId);
    
          if (!post.postObject) {
            return;
          }
    
          let dateTime = new Date(post.timestamp && post.timestamp.seconds ? post.timestamp.seconds * 1000 : 0);
    
          const isCreator = auth.currentUser && auth.currentUser.uid === post.postObject.uid;
          card.innerHTML = `
            <div class="card-header">
              <img class="avatar" src="${post.postObject.userprofile}" alt="User Avatar">
              <div class="user-info">
                <div class="user-name">${post.postObject.username}</div>
                <div class="timestamp">${dateTime.toLocaleString()}</div>
              </div>
              ${isCreator ? '<i class="fas fa-ellipsis-h nice-icon ml-auto popoverIcon"></i>' : ''} 
            </div>
            ${isCreator ? `
              <div class="popover-content">
                <button class="popover-action-btn btn btn-light" data-post-id="${post.id}" onclick="editPost('${post.id}')">Edit Post</button>
                <button class="popover-action-btn btn btn-light" data-post-id="${post.id}" onclick="deletePost('${post.id}')">Delete Post</button>
              </div>
            ` : ''}
            <div class="card-body">
              <p class="tweet-text">${post.postObject.text}</p>
              ${post.postObject.image ? `<img src="${post.postObject.image}" class="post-image" alt="Post Image">` : ''}
              <div class="card-footer">
      <i id="heartIcon_${post.id}" class="fa-regular fa-heart like-icon likeButton" data-type="heart" aria-hidden="true"><span class="like-count">${post.likes?.heart || 0}</span></i>
      <i id="smileIcon_${post.id}" class="fa-regular fa-face-smile like-icon likeButton" data-type="smile" aria-hidden="true"><span class="like-count">${post.likes?.smile || 0}</span></i>
      <i id="thumbsUpIcon_${post.id}" class="fa-solid fa-thumbs-up like-icon likeButton" data-type="thumbs-up" aria-hidden="true"><span class="like-count">${post.likes?.['thumbs-up'] || 0}</span></i>
    </div>

          `;
          const heartIcon = card.querySelector(`#heartIcon_${post.id}`);
  const smileIcon = card.querySelector(`#smileIcon_${post.id}`);
  const thumbsUpIcon = card.querySelector(`#thumbsUpIcon_${post.id}`);
    
          heartIcon.addEventListener('click', () => {
            if (auth.currentUser) {
              incrementLikeCount(post.id, auth.currentUser.email, 'heart');
            } else {
              console.log("User is not authenticated.");
            }
          });
    
          smileIcon.addEventListener('click', () => {
            if (auth.currentUser) {
              incrementLikeCount(post.id, auth.currentUser.email, 'smile');
            } else {
              console.log("User is not authenticated.");
            }
          });
    
          thumbsUpIcon.addEventListener('click', () => {
            if (auth.currentUser) {
              incrementLikeCount(post.id, auth.currentUser.email, 'thumbs-up');
            } else {
              console.log("User is not authenticated.");
            }
          });
    
          postsElement.appendChild(card);
          attachEventListenersToCard(card, post);
    
          function attachEventListenersToCard(card, post) {
            const popoverIcon = card.querySelector('.popoverIcon');
            if (popoverIcon) {
              popoverIcon.addEventListener('click', () => {
                if (auth.currentUser) {
                  const currentUserID = auth.currentUser.uid;
                  if (localStorage.getItem("user") === post.postObject.uid) {
                    const popoverContent = card.querySelector('.popover-content');
                    popoverContent.style.display = popoverContent.style.display === 'block' ? 'none' : 'block';
                  }
                }
              });
            }
          }
        });
      }
    
      document.addEventListener('DOMContentLoaded', () => {
        getPostsRealTime();
      });
    
      async function sendNotification(postId,username) {
        
    const username1 = localStorage.getItem('Name');
        try {
          const response = await fetch("https://fcm.googleapis.com/fcm/send", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization':`key=AAAAdwT_N08:APA91bEqk3mauwwbOjStFFgTErCKCWMzIoHEBLVCIcuwWvtc3a43dBvS2gVAsOy4BTFC6vhx8bNtrTaTAZ-tcZ2aG2Jguzc8RtsgSB6ciTqkJNOy3qfWNKMVNBB1ui1OWIPb9CZUWZ79`
            },
            body: JSON.stringify({
              "to": postId,
             "notification": {
             "title": "New Like",
              "body": username1 + " liked your post!"
                  },
            }
            
            ),
          });
    
          if (!response.ok) {
            throw new Error('Failed to send notification');
          }
    
          console.log('Notification sent successfully');
        } catch (error) {
          console.error('Error sending notification:', error);
        }
      }

  //     document.addEventListener('DOMContentLoaded', function() {
  //     document.body.addEventListener('click', async function(event) {
  //         var clickedElement = event.target.closest('.likeButton');
  //         if (clickedElement) {
  //             var likeType = clickedElement.getAttribute('data-type');

              
  //             var cardElement = clickedElement.closest('.card');
  //             var postId = cardElement ? cardElement.getAttribute('id') : null;
  //             var usernameElement = cardElement.querySelector('.user-name');
  //             var username = usernameElement ? usernameElement.textContent.trim() : 'Anonymous'; 


  //             if (postId) {
  //               console.log('Liked post with ID:', postId.replace("_",""));
  //                const postRef = doc(db, 'posts', postId.replace("_",""));
  //                let post = await getDoc(postRef)
  //                post = post.data();
  //               console.log("posts",post);
  //               sendNotification(post.postObject.fmcToken)
  //           }
  //             handleLikeButtonClick(likeType, username); 
  //         }
  //     });
  // });
  document.addEventListener('DOMContentLoaded', function() {
  document.body.addEventListener('click', async function(event) {
    var clickedElement = event.target.closest('.likeButton');
    if (clickedElement) {
      var likeType = clickedElement.getAttribute('data-type');

      var cardElement = clickedElement.closest('.card');
      var postId = cardElement ? cardElement.getAttribute('id') : null;
      var usernameElement = cardElement.querySelector('.user-name');
      var username = usernameElement ? usernameElement.textContent.trim() : 'Anonymous';

      if (postId) {
        console.log('Liked post with ID:', postId.replace("_",""));
        const postRef = doc(db, 'posts', postId.replace("_",""));
        let post = await getDoc(postRef)
        post = post.data();
        console.log("posts",post);
        sendNotification(post.postObject.fmcToken, username)
      }
    }
  });
});

    </script>
    
   <script>


  function handleLikeButtonClick(likeType, username) {
   
  }

  function showNotification(username) {

    const username1 = localStorage.getItem('Name');
      try {
          var notification = new Notification('Liked!', {
              body: 'Thanks for liking, ' + username1 + '!'
          });

          setTimeout(notification.close.bind(notification), 5000);
      } catch (e) {
          console.error('Failed to show notification:', e);
      }
  }





  </script>     


 
    
    </body>

</html>