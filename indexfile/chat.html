
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link rel="stylesheet" href="../js/chat.style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <script src="https://apis.google.com/js/api:client.js"></script>
    <title>Document</title>
</head>
<body>


  <style>


.popover-content {
  display: none;
  /* rest of your styles for popover content */
}

.popover-content.show {
  display: block;
}



.card-body .post-image {
  display: block;      
  margin-left: auto;    
  margin-right: auto;  
  max-width: 80%;      
  height: auto;       
}


  </style>
 
<div class="allchat">
  <div class="chat-home">
      <div class="container">
          <div class="row">
              <div class="col-sm-12">
                   <h1 class="text-center teah">Tech</h1>
                  <div class="spne">
                      <span>X</span>
                  </div> 

                
                  <div class="post-section">
                      <div class="post-btn">
                          <a href="./creat.html"><button id="post-button" class="btn btn-secondary">Create Post</button></a>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>



<div class="card-3">
    <div id="post-container">
   <div class="card-header">
    <img class="avatar" src="/img/whatsaap.jpeg" alt="User Avatar">
    <div class="user-info">
      <div class="user-name">Manful</div>
      <div class="timestamp">3 hours ago</div>
    
    </div> 
    <i id="popoverIcon" class="fas fa-ellipsis-h nice-icon ml-auto"></i>
    
</div>
<div id="popoverContent" class="popover-content">
 <a href="./edit.html"><button class="popover-action-btn" onclick="edit(event)">Edit Post</button></a>
  <button class="popover-action-btn">Delete Post</button>
</div>

 <div class="card-body" id="chatContent">
    <p class="tweet-text">
      Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua
      <br>
      
 
    </p>
  </div>

  <div class="card-footer">
    <i class="fa-regular fa-heart" aria-hidden="true"></i>
    <i class="fa-regular fa-face-smile" aria-hidden="true"></i>
    <i class="fa-solid fa-thumbs-up" aria-hidden="true"></i>
  </div>
 </div> 
 
 
 <div id="posts"></div>

    </div>  
 
 

<div class="mobilebar-container mobile-layout">
    <nav class="mobilebar-tab">
        <div id="applicationBarMobileButton1" class="mobilebar-tab-item active">
            <span class="mobilebar-tab__icon">
                <a href="./chat.html"> <i class="fa-solid fa-house"></i></a>
            </span>
        </div>
        <div class="mobilebar-tab-item">
            <span class="mobilebar-tab__icon">
                <a href="./profile.html"><i class="fa-solid fa-user"></i></a>
            </span>
        </div>
    </nav>
</div>






<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>






   
<script>



  
  function loadPosts() {
      const postsContainer = document.getElementById('post-container');
      const posts = JSON.parse(localStorage.getItem('posts')) || [];
      posts.reverse();
      posts.forEach(post => {
        const postElement = renderPost(post);
        postsContainer.insertAdjacentHTML('beforeend', postElement);
      });
  }
  
  document.addEventListener('DOMContentLoaded', loadPosts);
  

  document.addEventListener('click', function(event) {
      if (event.target.classList.contains('popoverIcon')) {

          const popoverContent = event.target.closest('.card-header').nextElementSibling;
          if (popoverContent) {
              popoverContent.classList.toggle('show');
          } else {
                console.error('Popover content not found for icon: ', event.target);
          
          }
      }
  });


  function editPost(postId) {
 
 window.location.href = `edit.html?postId=${postId}`;
}




 </script>







  
   <script type="module">

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
    import {
      getFirestore,
  collection,
  getDocs,
  deleteDoc,
  doc,
  updateDoc,
  increment,
  getDoc, // Make sure this import is added
  runTransaction 
    } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';
    
    const firebaseConfig = {
        apiKey: "AIzaSyDrUOrEvp3T277JmKPOWVAZ90gBIKC9S50",
        authDomain: "fir-b6449.firebaseapp.com",
        projectId: "fir-b6449",
        storageBucket: "fir-b6449.appspot.com",
        messagingSenderId: "511184942927",
        appId: "1:511184942927:web:debcb811d15856fd86b73a",
        measurementId: "G-2TM34PV1YN"
      };
      const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
  
  
  
    function cssEscape(str) {
   
    if (/^\d/.test(str)) {
      str = '_' + str;
    }
  
    return String(str).replace(/([!#$%&()*+,./:;<=>?@[\]^`{|}~])/g, '\\$1').replace(/:/g, '\\:');
  }
    






function updateLikeCountUI(postId, newType, oldType) {

}

async function updateLikeCount(postId, newType, oldType = null) {
  try {
    const postRef = doc(db, 'posts', postId);

    // Begin a transaction to ensure data consistency
    await runTransaction(db, async (transaction) => {
      const postDoc = await transaction.get(postRef);
      if (!postDoc.exists()) {
        throw new Error("Document does not exist!");
      }

      const postData = postDoc.data();
      const likes = postData.likes || {};
      const newLikesCount = (likes[newType] || 0) + 1;
      const updatedLikes = { ...likes, [newType]: newLikesCount };

      // If changing like types, decrement the old like
      if (oldType && likes[oldType]) {
        updatedLikes[oldType] = (likes[oldType] || 0) - 1;
      }

      // Update the document's like count
      transaction.update(postRef, { likes: updatedLikes, userLastLike: newType });
    });

    // Optionally update the UI
    updateLikeCountUI(postId, newType, oldType);
  } catch (error) {
    console.error("Failed to update like count:", error);
  }
}














    async function getPosts() {
      const postsCol = collection(db, 'posts'); 
      try {
        const postsSnapshot = await getDocs(postsCol);
        const postsList = postsSnapshot.docs.map(doc => {
          return { id: doc.id, ...doc.data() }; 
        });
       
        renderPosts(postsList);
      } catch (error) {
        console.error("Error fetching posts:", error);
      }
    }
    
    
    
    
    window.deletePost = async function(postId) {
      if (!postId) {
        console.error('No Post ID provided for deletion.');
        return;
      }
    
      const postRef = doc(db, 'posts', postId); 
    
      try {
        await deleteDoc(postRef); 
       
        getPosts(); 
      } catch (error) {
        console.error("Error deleting post:", error);
      }
    };
    
    
    
   
    
    function renderPosts(posts) {
  
      
    const postsElement = document.getElementById('posts');
    if (!postsElement) {
      console.error('No element with id "posts" found.');
      return;
    }
    postsElement.innerHTML = '';
   
    posts.forEach(post => {
        const postIdPrefix = /^\d/.test(post.id) ? '_' : '';
        const sanitizedPostId = cssEscape(postIdPrefix + post.id);
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.setAttribute('id', sanitizedPostId);
        
    
        let dateTime = new Date(post.postObject.timestamp.seconds * 1000);
    
        card.innerHTML = `
          <div class="card-header">
            <img class="avatar" src="${post.postObject.userprofile}" alt="User Avatar">
            <div class="user-info">
              <div class="user-name">${post.postObject.username}</div>
              <div class="timestamp">${dateTime.toLocaleString()}</div>
            </div>
            <i class="fas fa-ellipsis-h nice-icon ml-auto popoverIcon"></i> 
          </div>
          <div class="popover-content">
            <a href="./edit.html"><button class="popover-action-btn" data-post-id="${post.id}" onclick="editPost('${post.id}')">Edit Post</button></a>
           <button class="popover-action-btn" data-post-id="${post.id}" onclick="deletePost('${post.id}')">Delete Post</button>
    
          </div>
          <div class="card-body">
            <p class="tweet-text">${post.postObject.text}</p>
            ${post.postObject.image ? `<img src="${post.postObject.image}" class="post-image" alt="Post Image">` : ''}
          </div>
          <div class="card-footer">
    <i class="fa-regular fa-heart like-icon" data-type="heart" aria-hidden="true"></i><span class="like-count" data-type="heart">${post.likes?.heart || 0}</span>
    <i class="fa-regular fa-face-smile like-icon" data-type="smile" aria-hidden="true"></i><span class="like-count" data-type="smile">${post.likes?.smile || 0}</span>
    <i class="fa-solid fa-thumbs-up like-icon" data-type="thumbs-up" aria-hidden="true"></i><span class="like-count" data-type="thumbs-up">${post.likes?.['thumbs-up'] || 0}</span>
  </div>
        `;
    
  
  
  
        const heartIcon = card.querySelector('[data-type="heart"]');
const smileIcon = card.querySelector('[data-type="smile"]');
const thumbsUpIcon = card.querySelector('[data-type="thumbs-up"]');

heartIcon.addEventListener('click', () => incrementLikeCount(post.id, 'heart'));
smileIcon.addEventListener('click', () => incrementLikeCount(post.id, 'smile'));
thumbsUpIcon.addEventListener('click', () => incrementLikeCount(post.id, 'thumbs-up'));

      postsElement.appendChild(card);
  
      });
    }
   






    async function incrementLikeCount(postId, type, userId) {
  // First, check the current state of the user's last like
  const postRef = doc(db, 'posts', postId);
  const postDoc = await getDoc(postRef);

  if (postDoc.exists()) {
    const postData = postDoc.data();
    const lastLikeType = postData.userLastLike;

    if (lastLikeType && lastLikeType !== type) {
      // If there was a previous like of a different type, decrement it
      await updateLikeCount(postId, type, lastLikeType);
    } else if (!lastLikeType) {
      // If there was no previous like, just increment the new type
      await updateLikeCount(postId, type);
    } // No else - if the last like type is the same, we do nothing (user cannot like twice)
  }

}
    getPosts();
  
    </script> 








</body>
</html>